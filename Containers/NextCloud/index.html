
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Docker stack for getting started on IOT on the Raspberry PI">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.6">
    
    
      
        <title>Nextcloud - IOTstack</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.802231af.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#nextcloud" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="IOTstack" class="md-header__button md-logo" aria-label="IOTstack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IOTstack
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Nextcloud
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="IOTstack" class="md-nav__button md-logo" aria-label="IOTstack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    IOTstack
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        IOTStack Wiki
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Accessing-your-Device-from-the-internet/" class="md-nav__link">
        Accessing your device from the internet
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Backup-and-Restore/" class="md-nav__link">
        Backing up and restoring IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BuildStack-RandomPassword/" class="md-nav__link">
        Build Stack Random Services Password
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BuildStack-Services/" class="md-nav__link">
        Build Stack Services system
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Contributing-Services/" class="md-nav__link">
        Contributing a service to IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Custom/" class="md-nav__link">
        Custom services and overriding default settings for IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Default-Configs/" class="md-nav__link">
        Build Stack Default Passwords for Services
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Docker-commands/" class="md-nav__link">
        Docker commands
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Getting-Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Home/" class="md-nav__link">
        Wiki
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../How-the-script-works/" class="md-nav__link">
        How the script works
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Menu-System/" class="md-nav__link">
        Menu system
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Misc/" class="md-nav__link">
        Miscellaneous
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Native-RTL_433/" class="md-nav__link">
        Native RTL_433
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Networking/" class="md-nav__link">
        Networking
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../New-Menu-Release-Notes/" class="md-nav__link">
        New IOTstack Menu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../PostBuild-Script/" class="md-nav__link">
        Postbuild BASH Script
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../RPIEasy_native/" class="md-nav__link">
        RPIEasy
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Understanding-Containers/" class="md-nav__link">
        What is Docker?
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Updating-the-Project/" class="md-nav__link">
        Updating the project
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../gcgarner-migration/" class="md-nav__link">
        Migrating from gcgarner to SensorsIot
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_23" type="checkbox" id="__nav_23" checked>
      
      <label class="md-nav__link" for="__nav_23">
        Containers
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_23">
          <span class="md-nav__icon md-icon"></span>
          Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../AdGuardHome/" class="md-nav__link">
        AdGuard Home
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Adminer/" class="md-nav__link">
        Adminer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Blynk_server/" class="md-nav__link">
        Blynk server
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Chronograf/" class="md-nav__link">
        Chronograf
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../DashMachine/" class="md-nav__link">
        DashMachine
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../EspruinoHub/" class="md-nav__link">
        Espruinohub
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Grafana/" class="md-nav__link">
        Grafana
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Heimdall/" class="md-nav__link">
        Heimdall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Home-Assistant/" class="md-nav__link">
        Home assistant
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Homer/" class="md-nav__link">
        Homer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../InfluxDB/" class="md-nav__link">
        InfluxDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Kapacitor/" class="md-nav__link">
        Kapacitor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../MariaDB/" class="md-nav__link">
        MariaDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Mosquitto/" class="md-nav__link">
        Mosquitto
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../MotionEye/" class="md-nav__link">
        MotionEye
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Nextcloud
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Nextcloud
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#service-definition" class="md-nav__link">
     Service definition 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialising-nextcloud" class="md-nav__link">
     Initialising Nextcloud 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-through-untrusted-domain" class="md-nav__link">
    "Access through untrusted domain"
  </a>
  
    <nav class="md-nav" aria-label=""Access through untrusted domain"">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-a-dns-alias-for-your-nextcloud-service" class="md-nav__link">
     Using a DNS alias for your Nextcloud service 
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
     Security considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keeping-nextcloud-up-to-date" class="md-nav__link">
     Keeping Nextcloud up-to-date 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backups" class="md-nav__link">
     Backups 
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Node-RED/" class="md-nav__link">
        Node-RED
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Octoprint/" class="md-nav__link">
        OctoPrint – the snappy web interface for your 3D printer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Pi-hole/" class="md-nav__link">
        Pi-hole
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Plex/" class="md-nav__link">
        Plex
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Portainer-agent/" class="md-nav__link">
        Portainer agent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Portainer-ce/" class="md-nav__link">
        Portainer CE
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Portainer/" class="md-nav__link">
        Portainer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../PostgreSQL/" class="md-nav__link">
        PostgreSQL
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Python/" class="md-nav__link">
        Python
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../RTL_433-docker/" class="md-nav__link">
        RTL_433 Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../TasmoAdmin/" class="md-nav__link">
        TasmoAdmin
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Telegraf/" class="md-nav__link">
        Telegraf
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../WireGuard/" class="md-nav__link">
        WireGuard
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Zigbee2MQTT/" class="md-nav__link">
        Zigbee2MQTT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Zigbee2mqttassistant/" class="md-nav__link">
        Zigbee2Mqtt Assistant
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../deconz/" class="md-nav__link">
        deCONZ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../diyHue/" class="md-nav__link">
        DIY hue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../openHAB/" class="md-nav__link">
        openHAB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../x2go/" class="md-nav__link">
        x2go
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#service-definition" class="md-nav__link">
     Service definition 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialising-nextcloud" class="md-nav__link">
     Initialising Nextcloud 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-through-untrusted-domain" class="md-nav__link">
    "Access through untrusted domain"
  </a>
  
    <nav class="md-nav" aria-label=""Access through untrusted domain"">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-a-dns-alias-for-your-nextcloud-service" class="md-nav__link">
     Using a DNS alias for your Nextcloud service 
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
     Security considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keeping-nextcloud-up-to-date" class="md-nav__link">
     Keeping Nextcloud up-to-date 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backups" class="md-nav__link">
     Backups 
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="nextcloud">Nextcloud</h1>
<h2 id="service-definition"><a name="serviceDefinition"> Service definition </a></h2>
<p>This is the <strong>core</strong> of the IOTstack Nextcloud service definition:</p>
<div class="highlight"><pre><span></span><code>nextcloud:
  container_name: nextcloud
  image: nextcloud
  restart: unless-stopped
  environment:
    - MYSQL_HOST=nextcloud_db
    - MYSQL_PASSWORD=«user_password»
    - MYSQL_DATABASE=nextcloud
    - MYSQL_USER=nextcloud
  ports:
    - &quot;9321:80&quot;
  volumes:
    - ./volumes/nextcloud/html:/var/www/html
  depends_on:
    - nextcloud_db

nextcloud_db:
  container_name: nextcloud_db
  build: ./.templates/mariadb/.
  restart: unless-stopped
  environment:
    - TZ=Etc/UTC
    - PUID=1000
    - PGID=1000
    - MYSQL_ROOT_PASSWORD=«root_password»
    - MYSQL_PASSWORD=«user_password»
    - MYSQL_DATABASE=nextcloud
    - MYSQL_USER=nextcloud
  ports:
    - &quot;9322:3306&quot;
  volumes:
    - ./volumes/nextcloud/db:/config
    - ./volumes/nextcloud/db_backup:/backup
</code></pre></div>
<p>There are two containers, one for the cloud service itself, and the other for the database. Both containers share the same persistent storage area in the volumes subdirectory so they are treated as a unit. This will not interfere with any other MariaDB containers you might wish to run.</p>
<p>Depending on the IOTstack branch you are running, there may also be <code>networks:</code> directives. Other than to note that new menu dedicates a network to inter-container communications, those directives make no difference for this discussion.</p>
<p>Under old-menu, you are responsible for setting passwords. The passwords are "internal use only" and it is unlikely that you will need them unless you plan to go ferreting-about in the database using SQL. The rules are:</p>
<ul>
<li>The two instances of <code>«user_password»</code> <strong>must</strong> be the same.</li>
<li>The instance of <code>«root_password»</code> <em>should</em> be different from <code>«user_password»</code>.</li>
</ul>
<p>Under new-menu, the menu can generate random passwords for you. You can either use that feature or roll your own using the old-menu approach by replacing:</p>
<ul>
<li>Two instances of <code>%randomMySqlPassword%</code> (the <code>«user_password»</code>)</li>
<li>One instance of <code>%randomPassword%</code> (the <code>«root_password»</code>)</li>
</ul>
<p>The passwords need to be set before you bring up the Nextcloud service for the first time but the following initialisation steps assume you might not have done that and always start over from a clean slate.</p>
<h2 id="initialising-nextcloud"><a name="initialisation"> Initialising Nextcloud </a></h2>
<ol>
<li>
<p>Be in the correct directory:</p>
<div class="highlight"><pre><span></span><code>$ cd ~/IOTstack
</code></pre></div>
</li>
<li>
<p>If the stack is running, take it down:</p>
<div class="highlight"><pre><span></span><code>$ docker-compose down
</code></pre></div>
</li>
<li>
<p>Erase the persistent storage area for Nextcloud (double-check the command <em>before</em> you hit return):</p>
<div class="highlight"><pre><span></span><code>$ sudo rm -rf ./volumes/nextcloud
</code></pre></div>
<p>This is done to force re-initialisation. In particular, it gives you assurance that the passwords in your <code>docker-compose.yml</code> are the ones that are actually in effect.</p>
</li>
<li>
<p>Bring up the stack:</p>
<div class="highlight"><pre><span></span><code>$ docker-compose up -d
</code></pre></div>
</li>
<li>
<p>Check for errors:</p>
<p>Repeat the following command two or three times at 10-second intervals:</p>
<div class="highlight"><pre><span></span><code>$ docker ps
</code></pre></div>
<p>You are looking for evidence that the <code>nextcloud</code> and <code>nextcloud_db</code> containers are up, stable, and not restarting. If you see any evidence of restarts, try to figure out why using:</p>
<div class="highlight"><pre><span></span><code>$ docker logs nextcloud
</code></pre></div>
</li>
<li>
<p>If you want to be sure Nextcloud gets set up correctly, it is best to perform the remaining steps from a <strong>different</strong> computer.</p>
<p>That means you need to decide how that <strong>other</strong> computer will refer to your Raspberry Pi running Nextcloud. Your choices are:</p>
<ul>
<li>the IP address of your Raspberry Pi – eg <code>192.168.203.200</code></li>
<li>your Raspberry Pi's fully-qualified domain name – eg <code>myrpi.mydomain.com</code></li>
<li>your Raspberry Pi's host name – eg <code>myrpi</code></li>
</ul>
<p>Key points:</p>
<ul>
<li>You <strong>can't</strong> use a multicast domain name (eg <code>myrpi.local</code>). An mDNS name will not work until Nextcloud has been initialised!</li>
<li>Once you have picked a connection method, <strong>STICK TO IT</strong>.</li>
<li>You are only stuck with this restriction until Nextcloud has been initialised. You <strong>can</strong> (and should) fix it later by completing the steps in <a href="#untrustedDomain">"Access through untrusted domain"</a>.</li>
</ul>
</li>
<li>
<p>On a computer that is <strong>not</strong> the Raspberry Pi running Nextcloud, launch a browser and point to the Raspberry Pi running Nextcloud using your chosen connection method. Examples:</p>
<ul>
<li>
<p>If you are using an IP address:</p>
<div class="highlight"><pre><span></span><code>http://192.168.203.200:9321
</code></pre></div>
</li>
<li>
<p>If you are using a domain name:</p>
<div class="highlight"><pre><span></span><code>http://myrpi.mydomain.com:9321
</code></pre></div>
</li>
<li>
<p>If you are using a host name in <code>/etc/hosts</code>:</p>
<div class="highlight"><pre><span></span><code>http://myrpi:9321
</code></pre></div>
</li>
</ul>
<p>The expected result is:</p>
<p><img alt="Create Administrator Account" src="../images/nextcloud-createadminaccount.png" /></p>
</li>
<li>
<p>Create an administrator account and then click "Finish Setup".</p>
</li>
<li>
<p>There is a long delay. And then you get an error:</p>
<p><img alt="Mal-formed URL" src="../images/nextcloud-malformedurl.png" /></p>
<p>If you examine the contents of your browser's URL bar, you will find:</p>
<div class="highlight"><pre><span></span><code>http://localhost/index.php/core/apps/recommended
</code></pre></div>
<p>That is <strong>clearly</strong> wrong and it is probably a bug in Nextcloud.  <br />
10. Edit the URL to replace <code>localhost</code> with what it <em>should</em> be, which will be <strong>one</strong> of the following patterns, depending on which method you chose to access Nextcloud:</p>
<ul>
<li><code>http://192.168.203.200:9321/index.php/core/apps/recommended</code></li>
<li><code>http://myrpi.mydomain.com:9321/index.php/core/apps/recommended</code></li>
<li><code>http://myrpi:9321/index.php/core/apps/recommended</code></li>
</ul>
<p>Note:</p>
<ul>
<li>This seems to be the only time Nextcloud misbehaves and forces <code>localhost</code> into a URL.</li>
</ul>
</li>
<li>
<p>After a delay, you will see the "Recommended apps" screen with a spinner moving down the list of apps as they are loaded:</p>
<p><img alt="Recommended Apps" src="../images/nextcloud-recommendedapps.png" /></p>
<p>Wait for the loading to complete.</p>
</li>
<li>
<p>Eventually, the dashboard will appear. Then the dashboard will be obscured by the "Nextcloud Hub" floating window:</p>
<p><img alt="Post-initialisation" src="../images/nextcloud-postinitialisation.png" /></p>
<p>Hover your mouse to the right of the floating window and keep clicking on the right-arrow button until you reach the last screen, then click "Start using Nextcloud".</p>
</li>
<li>
<p>Congratulations. Your IOTstack implementation of Nextcloud is ready to roll:</p>
<p><img alt="Dashboard" src="../images/nextcloud-dashboard.png" /></p>
</li>
</ol>
<h2 id="access-through-untrusted-domain"><a name="untrustedDomain">"Access through untrusted domain"</a></h2>
<p>During Nextcloud initialisation you had to choose between an IP address, a domain name or a host name. Now that Nextcloud is running, you have the opportunity to expand your connection options.</p>
<blockquote>
<p>If you are reading this because you are staring at an "access through untrusted domain" message then you have come to the right place.</p>
</blockquote>
<p>Let's assume the following:</p>
<ul>
<li>You used <code>raspi-config</code> to give your Raspberry Pi the name "myrpi".</li>
<li>Your Raspberry Pi has the fixed IP address "192.168.203.200" (via either a static binding in your DHCP server or a static IP address on your Raspberry Pi).</li>
</ul>
<p>Out of the box, a Raspberry Pi participates in multicast DNS so it will also have the mDNS name:</p>
<ul>
<li>"myrpi.local"</li>
</ul>
<p>Let's also assume you have a local Domain Name System server where your Raspberry Pi:</p>
<ul>
<li>has the canonical name (A record) "myrpi.mydomain.com"; plus</li>
<li>an alias (CNAME record) of "nextcloud.mydomain.com".</li>
</ul>
<p>Rolling all that together, you would expect your Nextcloud service to be reachable at any of the following URLs:</p>
<ul>
<li><code>http://192.168.203.200:9321</code></li>
<li><code>http://myrpi.local:9321</code></li>
<li><code>http://myrpi.mydomain.com:9321</code></li>
<li><code>http://nextcloud.mydomain.com:9321</code></li>
</ul>
<p>To tell Nextcloud that all of those URLs are valid, you need to use <code>sudo</code> and your favourite text editor to edit this file:</p>
<div class="highlight"><pre><span></span><code>~/IOTstack/volumes/nextcloud/html/config/config.php
</code></pre></div>
<p>Hint:</p>
<ul>
<li>
<p>It is a good idea to make a backup of any file before you edit it. For example:</p>
<div class="highlight"><pre><span></span><code>$ cd ~/IOTstack/volumes/nextcloud/html/config/
$ sudo cp config.php config.php.bak
</code></pre></div>
</li>
</ul>
<p>Search for "trusted_domains". To tell Nextcloud to trust <strong>all</strong> of the URLs above, edit the array structure like this:</p>
<div class="highlight"><pre><span></span><code>  &#39;trusted_domains&#39; =&gt;
  array (
    0 =&gt; &#39;192.168.203.200:9321&#39;,
    1 =&gt; &#39;myrpi.local:9321&#39;,
    2 =&gt; &#39;myrpi.mydomain.com:9321&#39;,
    3 =&gt; &#39;nextcloud.mydomain.com:9321&#39;,
  ),
</code></pre></div>
<blockquote>
<p>Note: <em>all</em> the trailing commas are intentional!</p>
</blockquote>
<p>Once you have finished editing the file, save your work then restart Nextcloud:</p>
<div class="highlight"><pre><span></span><code>$ cd ~/IOTstack
$ docker-compose restart nextcloud
</code></pre></div>
<p>Use <code>docker ps</code> to check that the container has restarted properly and hasn't gone into a restart loop.</p>
<p>See also:</p>
<ul>
<li><a href="https://docs.nextcloud.com/server/21/admin_manual/installation/installation_wizard.html#trusted-domains">Nextcloud documentation - trusted domains</a>.</li>
</ul>
<h3 id="using-a-dns-alias-for-your-nextcloud-service"><a name="dnsAlias"> Using a DNS alias for your Nextcloud service </a></h3>
<p>The examples above include using a DNS alias (a CNAME record) for your Nextcloud service. If you decide to do that, you may see this warning in the log:</p>
<div class="highlight"><pre><span></span><code>Could not reliably determine the server&#39;s fully qualified domain name
</code></pre></div>
<p>You can silence the warning by editing the Nextcloud service definition in <code>docker-compose.yml</code> to add your fully-qualified DNS alias to at <code>hostname</code> directive. For example:</p>
<div class="highlight"><pre><span></span><code>    hostname: nextcloud.mydomain.com
</code></pre></div>
<h2 id="security-considerations"><a name="security"> Security considerations</a></h2>
<p>Nextcloud traffic is not encrypted. Do <strong>not</strong> expose it to the web by opening a port on your home router. Instead, use a VPN like Wireguard to provide secure access to your home network, and let your remote clients access Nextcloud over the VPN tunnel.</p>
<h2 id="keeping-nextcloud-up-to-date"><a name="updatingNextcloud"> Keeping Nextcloud up-to-date </a></h2>
<p>To update the <code>nextcloud</code> container:</p>
<div class="highlight"><pre><span></span><code>$ cd ~/IOTstack
$ docker-compose pull nextcloud
$ docker-compose up -d nextcloud
$ docker system prune
</code></pre></div>
<p>To update the <code>nextcloud_db</code> container:</p>
<div class="highlight"><pre><span></span><code>$ cd ~/IOTstack
$ docker-compose build --no-cache --pull nextcloud_db
$ docker-compose up -d nextcloud_db
$ docker system prune
$ docker system prune
</code></pre></div>
<p>The first "prune" removes the old <em>local</em> image, the second removes the old <em>base</em> image.</p>
<h2 id="backups"><a name="backups"> Backups </a></h2>
<p>Nextcloud is currently excluded from the IOTstack-supplied backup scripts due to its potential size.</p>
<blockquote>
<p>This is also true for <a href="https://github.com/Paraphraser/IOTstackBackup">Paraphraser/IOTstackBackup</a>.</p>
</blockquote>
<p>If you want to take a backup, something like the following will get the job done:</p>
<div class="highlight"><pre><span></span><code>$ cd ~/IOTstack
$ BACKUP_TAR_GZ=$PWD/backups/$(date +&quot;%Y-%m-%d_%H%M&quot;).$HOSTNAME.nextcloud-backup.tar.gz
$ touch &quot;$BACKUP_TAR_GZ&quot;
$ docker-compose stop nextcloud nextcloud_db
$ docker-compose rm -f nextcloud nextcloud_db
$ sudo tar -czf &quot;$BACKUP_TAR_GZ&quot; -C &quot;./volumes/nextcloud&quot; .
$ docker-compose up -d
</code></pre></div>
<p>Note:</p>
<ul>
<li>A <em>baseline</em> backup takes over 400MB and about 2 minutes. Once you start adding your own data, it will take even more time and storage.</li>
</ul>
<p>To restore, you first need to identify the name of the backup file by looking in the <code>backups</code> directory. Then:</p>
<div class="highlight"><pre><span></span><code>$ cd ~/IOTstack
$ RESTORE_TAR_GZ=$PWD/backups/2021-06-12_1321.sec-dev.nextcloud-backup.tar.gz
$ docker-compose stop nextcloud nextcloud_db
$ docker-compose rm -f nextcloud nextcloud_db
$ sudo rm -rf ./volumes/nextcloud/*
$ sudo tar -x --same-owner -z -f &quot;$RESTORE_TAR_GZ&quot; -C &quot;./volumes/nextcloud&quot;
$ docker-compose up -d
</code></pre></div>
<p>If you are running from an SD card, it would be a good idea to mount an external drive to store the data. Something like:</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/46672225/69873297-a3d6b700-12c0-11ea-98c9-40f358137b77.png" /></p>
<p>The external drive will have to be an ext4 formatted drive because smb, fat32 and NTFS can't handle Linux file permissions. If the permissions aren't set to "www-data" then the container won't be able to write to the disk.</p>
<p>Finally, a warning:</p>
<ul>
<li>If your database gets corrupted then your Nextcloud is pretty much stuffed.</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../MotionEye/" class="md-footer__link md-footer__link--prev" aria-label="Previous: MotionEye" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              MotionEye
            </div>
          </div>
        </a>
      
      
        
        <a href="../Node-RED/" class="md-footer__link md-footer__link--next" aria-label="Next: Node-RED" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Node-RED
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.409db549.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.756773cc.min.js"></script>
      
    
  </body>
</html>