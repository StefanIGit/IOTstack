
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Docker stack for getting started on IOT on the Raspberry PI">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.6">
    
    
      
        <title>Telegraf - IOTstack</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.802231af.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#telegraf" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="IOTstack" class="md-header__button md-logo" aria-label="IOTstack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IOTstack
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Telegraf
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="IOTstack" class="md-nav__button md-logo" aria-label="IOTstack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    IOTstack
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        IOTStack Wiki
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Accessing-your-Device-from-the-internet/" class="md-nav__link">
        Accessing your device from the internet
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Backup-and-Restore/" class="md-nav__link">
        Backing up and restoring IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BuildStack-RandomPassword/" class="md-nav__link">
        Build Stack Random Services Password
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../BuildStack-Services/" class="md-nav__link">
        Build Stack Services system
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Contributing-Services/" class="md-nav__link">
        Contributing a service to IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Custom/" class="md-nav__link">
        Custom services and overriding default settings for IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Default-Configs/" class="md-nav__link">
        Build Stack Default Passwords for Services
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Docker-commands/" class="md-nav__link">
        Docker commands
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Getting-Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Home/" class="md-nav__link">
        Wiki
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../How-the-script-works/" class="md-nav__link">
        How the script works
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Menu-System/" class="md-nav__link">
        Menu system
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Misc/" class="md-nav__link">
        Miscellaneous
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Native-RTL_433/" class="md-nav__link">
        Native RTL_433
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Networking/" class="md-nav__link">
        Networking
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../New-Menu-Release-Notes/" class="md-nav__link">
        New IOTstack Menu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../PostBuild-Script/" class="md-nav__link">
        Postbuild BASH Script
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../RPIEasy_native/" class="md-nav__link">
        RPIEasy
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Understanding-Containers/" class="md-nav__link">
        What is Docker?
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Updating-the-Project/" class="md-nav__link">
        Updating the project
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../gcgarner-migration/" class="md-nav__link">
        Migrating from gcgarner to SensorsIot
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_23" type="checkbox" id="__nav_23" checked>
      
      <label class="md-nav__link" for="__nav_23">
        Containers
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_23">
          <span class="md-nav__icon md-icon"></span>
          Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../AdGuardHome/" class="md-nav__link">
        AdGuard Home
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Adminer/" class="md-nav__link">
        Adminer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Blynk_server/" class="md-nav__link">
        Blynk server
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Chronograf/" class="md-nav__link">
        Chronograf
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../DashMachine/" class="md-nav__link">
        DashMachine
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../EspruinoHub/" class="md-nav__link">
        Espruinohub
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Grafana/" class="md-nav__link">
        Grafana
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Heimdall/" class="md-nav__link">
        Heimdall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Home-Assistant/" class="md-nav__link">
        Home assistant
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Homer/" class="md-nav__link">
        Homer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../InfluxDB/" class="md-nav__link">
        InfluxDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Kapacitor/" class="md-nav__link">
        Kapacitor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../MariaDB/" class="md-nav__link">
        MariaDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Mosquitto/" class="md-nav__link">
        Mosquitto
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../MotionEye/" class="md-nav__link">
        MotionEye
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../NextCloud/" class="md-nav__link">
        Nextcloud
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Node-RED/" class="md-nav__link">
        Node-RED
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Octoprint/" class="md-nav__link">
        OctoPrint – the snappy web interface for your 3D printer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Pi-hole/" class="md-nav__link">
        Pi-hole
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Plex/" class="md-nav__link">
        Plex
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Portainer-agent/" class="md-nav__link">
        Portainer agent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Portainer-ce/" class="md-nav__link">
        Portainer CE
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Portainer/" class="md-nav__link">
        Portainer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../PostgreSQL/" class="md-nav__link">
        PostgreSQL
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Python/" class="md-nav__link">
        Python
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../RTL_433-docker/" class="md-nav__link">
        RTL_433 Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../TasmoAdmin/" class="md-nav__link">
        TasmoAdmin
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Telegraf
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Telegraf
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
     References 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#significant-directories-and-files" class="md-nav__link">
     Significant directories and files 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-telegraf-gets-built-for-iotstack" class="md-nav__link">
     How Telegraf gets built for IOTstack 
  </a>
  
    <nav class="md-nav" aria-label=" How Telegraf gets built for IOTstack ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#telegraf-images-dockerhub" class="md-nav__link">
     Telegraf images (DockerHub) 
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iotstack-menu" class="md-nav__link">
     IOTstack menu 
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iotstack-first-run" class="md-nav__link">
     IOTstack first run 
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-considerations" class="md-nav__link">
     Migration considerations 
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
     Logging 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrading-telegraf" class="md-nav__link">
     Upgrading Telegraf 
  </a>
  
    <nav class="md-nav" aria-label=" Upgrading Telegraf ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#telegraf-version-pinning" class="md-nav__link">
     Telegraf version pinning 
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../WireGuard/" class="md-nav__link">
        WireGuard
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Zigbee2MQTT/" class="md-nav__link">
        Zigbee2MQTT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Zigbee2mqttassistant/" class="md-nav__link">
        Zigbee2Mqtt Assistant
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../deconz/" class="md-nav__link">
        deCONZ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../diyHue/" class="md-nav__link">
        DIY hue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../openHAB/" class="md-nav__link">
        openHAB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../x2go/" class="md-nav__link">
        x2go
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
     References 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#significant-directories-and-files" class="md-nav__link">
     Significant directories and files 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-telegraf-gets-built-for-iotstack" class="md-nav__link">
     How Telegraf gets built for IOTstack 
  </a>
  
    <nav class="md-nav" aria-label=" How Telegraf gets built for IOTstack ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#telegraf-images-dockerhub" class="md-nav__link">
     Telegraf images (DockerHub) 
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iotstack-menu" class="md-nav__link">
     IOTstack menu 
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iotstack-first-run" class="md-nav__link">
     IOTstack first run 
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-considerations" class="md-nav__link">
     Migration considerations 
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
     Logging 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrading-telegraf" class="md-nav__link">
     Upgrading Telegraf 
  </a>
  
    <nav class="md-nav" aria-label=" Upgrading Telegraf ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#telegraf-version-pinning" class="md-nav__link">
     Telegraf version pinning 
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="telegraf">Telegraf</h1>
<p>This document discusses an IOTstack-specific version of Telegraf built on top of <a href="https://github.com/influxdata/influxdata-docker/tree/master/telegraf">influxdata/influxdata-docker/telegraf</a> using a <em>Dockerfile</em>.</p>
<p>The purpose of the Dockerfile is to enable the container to perform self-repair if the <code>telegraf.conf</code> configuration file disappears.</p>
<h2 id="references"><a name="references"> References </a></h2>
<ul>
<li><a href="https://www.influxdata.com/time-series-platform/telegraf/"><em>influxdata Telegraf</em> home</a></li>
<li><a href="https://github.com/influxdata/influxdata-docker/tree/master/telegraf"><em>GitHub</em>: influxdata/influxdata-docker/telegraf</a></li>
<li><a href="https://hub.docker.com/_/telegraf"><em>DockerHub</em>: influxdata Telegraf</a></li>
</ul>
<h2 id="significant-directories-and-files"><a name="significantFiles"> Significant directories and files </a></h2>
<div class="highlight"><pre><span></span><code>~/IOTstack
├── .templates
│   └── telegraf
│       ├── Dockerfile ❶
│       ├── entrypoint.sh ❷
│       └── service.yml ❸
├── services
│   └── telegraf
│       └── service.yml ❹
├── docker-compose.yml ❺
└── volumes
    └── telegraf ❻
        └── telegraf.conf ❼
</code></pre></div>
<ol>
<li>The <em>Dockerfile</em> used to customise Telegraf for IOTstack.</li>
<li>A replacement for the <code>telegraf</code> container script of the same name, extended to handle container self-repair.</li>
<li>The <em>template service definition</em>.</li>
<li>The <em>working service definition</em> (only relevant to old-menu, copied from ❸).</li>
<li>The <em>Compose</em> file (includes ❸).</li>
<li>The <em>persistent storage area</em> for the <code>telegraf</code> container.</li>
<li>The configuration file. Will be created by default if not present in ❻ when the container starts but will not be overwritten if customised by you.</li>
</ol>
<h2 id="how-telegraf-gets-built-for-iotstack"><a name="howTelegrafIOTstackGetsBuilt"> How Telegraf gets built for IOTstack </a></h2>
<h3 id="telegraf-images-dockerhub"><a name="dockerHubImages"> Telegraf images (<a href="https://hub.docker.com"><em>DockerHub</em></a>) </a></h3>
<p>Periodically, the source code is recompiled and the resulting image is pushed to <a href="https://hub.docker.com/_/telegraf?tab=tags&amp;page=1&amp;ordering=last_updated">influxdata Telegraf</a> on <em>DockerHub</em>.</p>
<h3 id="iotstack-menu"><a name="iotstackMenu"> IOTstack menu </a></h3>
<p>When you select Telegraf in the IOTstack menu, the <em>template service definition</em> is copied into the <em>Compose</em> file.</p>
<blockquote>
<p>Under old menu, it is also copied to the <em>working service definition</em> and then not really used.</p>
</blockquote>
<h3 id="iotstack-first-run"><a name="iotstackFirstRun"> IOTstack first run </a></h3>
<p>On a first install of IOTstack, you run the menu, choose your containers, and are told to do this:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> ~/IOTstack
$ docker-compose up -d
</code></pre></div>
<blockquote>
<p>See also the <a href="#migration">Migration considerations</a> (below).</p>
</blockquote>
<p><code>docker-compose</code> reads the <em>Compose</em> file. When it arrives at the <code>telegraf</code> fragment, it finds:</p>
<div class="highlight"><pre><span></span><code>  telegraf:
    container_name: telegraf
    build: ./.templates/telegraf/.
    …
</code></pre></div>
<p>The <code>build</code> statement tells <code>docker-compose</code> to look for:</p>
<div class="highlight"><pre><span></span><code>~/IOTstack/.templates/telegraf/Dockerfile
</code></pre></div>
<blockquote>
<p>The <em>Dockerfile</em> is in the <code>.templates</code> directory because it is intended to be a common build for <strong>all</strong> IOTstack users. This is different to the arrangement for Node-RED where the <em>Dockerfile</em> is in the <code>services</code> directory because it is how each individual IOTstack user's version of Node-RED is customised.</p>
</blockquote>
<p>The <em>Dockerfile</em> begins with:</p>
<div class="highlight"><pre><span></span><code>FROM telegraf:latest
</code></pre></div>
<blockquote>
<p>If you need to pin to a particular version of Telegraf, the <em>Dockerfile</em> is the place to do it. See <a href="#versionPinning">Telegraf version pinning</a>.</p>
</blockquote>
<p>The <code>FROM</code> statement tells the build process to pull down the <strong><em>base image</em></strong> from <a href="https://hub.docker.com"><em>DockerHub</em></a>.</p>
<blockquote>
<p>It is a <strong><em>base</em></strong> image in the sense that it never actually runs as a container on your Raspberry Pi.</p>
</blockquote>
<p>The remaining instructions in the <em>Dockerfile</em> customise the <em>base image</em> to produce a <strong><em>local image</em></strong>. The customisations are:</p>
<ol>
<li>Add the <code>rsync</code> package. This helps the container perform self-repair.</li>
<li>Make a backup copy of the default <code>telegraf.conf</code>. The backup is used to re-create the working copy if that ever gets removed from the persistent storage area.</li>
<li>
<p>Replace <code>entrypoint.sh</code> with a version which:</p>
<ul>
<li>calls <code>rsync</code> to perform self-repair if <code>telegraf.conf</code> goes missing; and</li>
<li>enforces root:root ownership in <code>~/IOTstack/volumes/telegraf</code>.</li>
</ul>
</li>
</ol>
<p>The <em>local image</em> is instantiated to become your running container.</p>
<p>When you run the <code>docker images</code> command after Telegraf has been built, you will see two rows for Telegraf:</p>
<div class="highlight"><pre><span></span><code>$ docker images
REPOSITORY          TAG      IMAGE ID       CREATED       SIZE
iotstack_telegraf   latest   59861b7fe9ed   <span class="m">2</span> hours ago   292MB
telegraf            latest   a721ac170fad   <span class="m">3</span> days ago    273MB
</code></pre></div>
<ul>
<li><code>telegraf</code> is the <em>base image</em>; and</li>
<li><code>iotstack_telegraf</code> is the <em>local image</em>.</li>
</ul>
<p>You will see the same pattern in <em>Portainer</em>, which reports the <em>base image</em> as "unused". You should not remove the <em>base</em> image, even though it appears to be unused.</p>
<h3 id="migration-considerations"><a name="migration"> Migration considerations </a></h3>
<p>Under the original IOTstack implementation of Telegraf (just "as it comes" from <em>DockerHub</em>), the service definition expected <code>telegraf.conf</code> to be at:</p>
<div class="highlight"><pre><span></span><code>~/IOTstack/services/telegraf/telegraf.conf
</code></pre></div>
<p>Under this implementation of Telegraf, the configuration file has moved to:</p>
<div class="highlight"><pre><span></span><code>~/IOTstack/volumes/telegraf/telegraf.conf
</code></pre></div>
<blockquote>
<p>The change of location is one of the things that allows self-repair to work properly. </p>
</blockquote>
<p>The default version the configuration file supplied with earlier versions of IOTstack only contained 237 lines. At the time of writing (August 2021), the default version supplied with the Telegraf image downloaded from <em>DockerHub</em> contains 8641 lines.</p>
<blockquote>
<p>That is a <strong>significant</strong> difference. It is not clear why the version supplied with the original <a href="https://github.com/gcgarner/IOTstack/blob/master/.templates/telegraf/telegraf.conf">gcgarner/IOTstack</a> was so short. Nevertheless, that file was inherited by <a href="https://github.com/SensorsIot/IOTstack/blob/master/.templates/telegraf/telegraf.conf">SensorsIot/IOTstack</a> and has never been changed.</p>
</blockquote>
<p>If you did not need to alter the 237-line file when you were running the original IOTstack implementation of Telegraf, it is <em>readonably</em> likely that the 8641-line default will also work, and that there will be no change in Telegraf's behaviour when it is built from a <em>Dockerfile</em>.</p>
<p>However, if you experience problems then you have two choices:</p>
<ol>
<li>
<p>Use your old <code>telegraf.conf</code>:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> ~/IOTstack
$ docker-compose rm --force --stop -v telegraf
$ sudo cp ./services/telegraf/telegraf.conf ./volumes/telegraf/telegraf.conf
$ docker-compose up -d telegraf
</code></pre></div>
</li>
<li>
<p>Work out which options you need to change in the 8641-line version. You can use your favourite Unix text editor. To cause Telegraf to notice your changes:</p>
<div class="highlight"><pre><span></span><code>$ cd ~/IOTstack
$ docker-compose restart telegraf
</code></pre></div>
</li>
</ol>
<h2 id="logging"><a name="logging"> Logging </a></h2>
<p>You can inspect Telegraf's log by:</p>
<div class="highlight"><pre><span></span><code>$ docker logs telegraf
</code></pre></div>
<p>These logs are ephemeral and will disappear when your Telegraf container is rebuilt.</p>
<h2 id="upgrading-telegraf"><a name="upgradingTelegraf"> Upgrading Telegraf </a></h2>
<p>You can update most containers like this:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> ~/IOTstack
$ docker-compose pull
$ docker-compose up -d
$ docker system prune
</code></pre></div>
<p>In words:</p>
<ul>
<li><code>docker-compose pull</code> downloads any newer images;</li>
<li><code>docker-compose up -d</code> causes any newly-downloaded images to be instantiated as containers (replacing the old containers); and</li>
<li>the <code>prune</code> gets rid of the outdated images.</li>
</ul>
<p>This strategy doesn't work when a <em>Dockerfile</em> is used to build a <em>local image</em> on top of a <em>base image</em> downloaded from <a href="https://hub.docker.com"><em>DockerHub</em></a>. The <em>local image</em> is what is running so there is no way for the <code>pull</code> to sense when a newer version becomes available.</p>
<p>The only way to know when an update to Telegraf is available is to check the <a href="https://hub.docker.com/_/telegraf?tab=tags&amp;page=1&amp;ordering=last_updated">Telegraf tags page</a> on <em>DockerHub</em>.</p>
<p>Once a new version appears on <em>DockerHub</em>, you can upgrade Telegraf like this:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> ~/IOTstack
$ docker-compose build --no-cache --pull telegraf
$ docker-compose up -d telegraf
$ docker system prune
$ docker system prune
</code></pre></div>
<p>Breaking it down into parts:</p>
<ul>
<li><code>build</code> causes the named container to be rebuilt;</li>
<li><code>--no-cache</code> tells the <em>Dockerfile</em> process that it must not take any shortcuts. It really <strong>must</strong> rebuild the <em>local image</em>;</li>
<li><code>--pull</code> tells the <em>Dockerfile</em> process to actually check with <a href="https://hub.docker.com"><em>DockerHub</em></a> to see if there is a later version of the <em>base image</em> and, if so, to download it before starting the build;</li>
<li><code>telegraf</code> is the named container argument required by the <code>build</code> command.</li>
</ul>
<p>Your existing Telegraf container continues to run while the rebuild proceeds. Once the freshly-built <em>local image</em> is ready, the <code>up</code> tells <code>docker-compose</code> to do a new-for-old swap. There is barely any downtime for your service.</p>
<p>The <code>prune</code> is the simplest way of cleaning up. The first call removes the old <em>local image</em>. The second call cleans up the old <em>base image</em>.</p>
<h3 id="telegraf-version-pinning"><a name="versionPinning"> Telegraf version pinning </a></h3>
<p>If you need to pin Telegraf to a particular version:</p>
<ol>
<li>
<p>Use your favourite text editor to open the following file:</p>
<div class="highlight"><pre><span></span><code>~/IOTstack/.templates/telegraf/Dockerfile
</code></pre></div>
</li>
<li>
<p>Find the line:</p>
<div class="highlight"><pre><span></span><code>FROM telegraf:latest
</code></pre></div>
</li>
<li>
<p>Replace <code>latest</code> with the version you wish to pin to. For example, to pin to version 1.19.3:</p>
<div class="highlight"><pre><span></span><code>FROM telegraf:1.19.3
</code></pre></div>
</li>
<li>
<p>Save the file and tell <code>docker-compose</code> to rebuild the local image:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> ~/IOTstack
$ docker-compose up -d --build telegraf
$ docker system prune
</code></pre></div>
<p>The new <em>local image</em> is built, then the new container is instantiated based on that image. The <code>prune</code> deletes the old <em>local image</em>.</p>
</li>
</ol>
<p>Note:</p>
<ul>
<li>As well as preventing Docker from updating the <em>base image</em>, pinning will also block incoming updates to the <em>Dockerfile</em> from a <code>git pull</code>. Nothing will change until you decide to remove the pin.</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../TasmoAdmin/" class="md-footer__link md-footer__link--prev" aria-label="Previous: TasmoAdmin" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              TasmoAdmin
            </div>
          </div>
        </a>
      
      
        
        <a href="../WireGuard/" class="md-footer__link md-footer__link--next" aria-label="Next: WireGuard" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              WireGuard
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.409db549.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.756773cc.min.js"></script>
      
    
  </body>
</html>